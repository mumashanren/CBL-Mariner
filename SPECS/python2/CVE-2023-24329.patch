From e330c2c7ab1631718a47b128813b740bccae7fe9 Mon Sep 17 00:00:00 2001
From: Mitch Zhu <mitchzhu@microsoft.com>
Date: Mon, 6 Mar 2023 20:10:26 +0000
Subject: [PATCH] CVE-2023-24329 patch backported from 3.11

---
 Lib/urlparse.py | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/Lib/urlparse.py b/Lib/urlparse.py
index b800146..d2004a0 100644
--- a/Lib/urlparse.py
+++ b/Lib/urlparse.py
@@ -193,6 +193,13 @@ def _remove_unsafe_bytes_from_url(url):
         url = url.replace(b, "")
     return url
 
+def _ctoi(c):
+    if isinstance(c, str):
+        return ord(c)
+    else:
+        return c
+        
+def isascii(c): return 0 <= _ctoi(c) <= 127
 
 def urlsplit(url, scheme='', allow_fragments=True):
     """Parse a URL into 5 components:
@@ -211,7 +218,7 @@ def urlsplit(url, scheme='', allow_fragments=True):
         clear_cache()
     netloc = query = fragment = ''
     i = url.find(':')
-    if i > 0:
+    if i > 0 and isinstance(url[0], str) and isascii(url[0]) and url[0].isalpha():
         if url[:i] == 'http': # optimize the common case
             scheme = url[:i].lower()
             url = url[i+1:]
-- 
2.33.4

