Modified patch 8040e0b04e48d2cf1a2853e8ac2c2561e18c4a11 to apply to
CBL-Mariner: Applied patch changes in older version of file
Modified-by: Sumedh Sharma<sumsharma@microsoft.com>
From 2f827a0e72ffba3f0ebf7e541a802abb70557213 Mon Sep 17 00:00:00 2001
From: davkor <david@adalogics.com>
Date: Tue, 23 Feb 2021 22:17:32 +0000
Subject: [PATCH] pack: fix type confusion bugs. Amongst other OSS-Fuzz
 5136174263566336

Signed-off-by: davkor <david@adalogics.com>
---
 src/flb_pack.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/flb_pack.c b/src/flb_pack.c
index a53cb19..8d45e58 100644
--- a/src/flb_pack.c
+++ b/src/flb_pack.c
@@ -760,6 +760,9 @@ flb_sds_t flb_pack_msgpack_to_json_format(const char *data, uint64_t bytes,
     while (msgpack_unpack_next(&result, data, bytes, &off) == ok) {
         /* Each array must have two entries: time and record */
         root = result.data;
+        if (root.type != MSGPACK_OBJECT_ARRAY) {
+            continue;
+        }
         if (root.via.array.size != 2) {
             continue;
         }
@@ -769,6 +772,9 @@ flb_sds_t flb_pack_msgpack_to_json_format(const char *data, uint64_t bytes,
 
         /* Get the record/map */
         map = root.via.array.ptr[1];
+        if (map.type != MSGPACK_OBJECT_MAP) {
+            continue;
+        }
         map_size = map.via.map.size;
         msgpack_pack_map(&tmp_pck, map_size + 1);
 
-- 
2.25.1

